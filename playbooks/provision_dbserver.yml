---

- name: provision dbserver
  hosts: db-servers
  remote_user: "{{ user }}"

  handlers:
    - include: ../roles/shared_handlers/handlers/main.yml

  roles:
    - role: ssh_keys
      become: yes
      tags: ssh_keys

    - role: geerlingguy.security
      become: yes
      become_user: root
      tags: security

    - role: language
      tags: language

  tasks:
    - name: install postgres
      include_role:
        name: dbserver
        tasks_from: postgresql.yml

    - name: ensure postgres conf.d directory exists
      file:
        dest: "{{ postgresql_config_path }}/conf.d"
        state: directory
        owner: postgres
        group: postgres
        mode: 0740
      become: yes

    - meta: flush_handlers # Ensure handlers run successfully before reporting success

    - name: notify slack
      slack:
        token: "T02G54U79/BF25P9F7A/DJdtYaLLUpRJPiu72d8NqgGg"
        msg: 'DB server {{ inventory_hostname }} provisioned'
        channel: "#devops-notifications"
        username: "ansible executed by {{ lookup('env','USER') }}"
      when: inventory_hostname not in groups['local']
