--- # dbserver

- name: provision dbserver keys
  include_tasks: dbserver_keys.yml
  vars:
    postgresql_version: "{{ dbserver_postgres_version }}"
  when: db_host != "localhost"

- import_tasks: local_postgres.yml
  when: db_host == 'localhost'

- import_tasks: remote_postgres.yml
  when: db_host != 'localhost'

- name: add custom log directory
  file:
    state: directory
    dest: /var/log/pg_log
    mode: 0750
    owner: postgres
    group: postgres
  become: yes

- name: add postgres conf.d directory
  file:
    dest: "{{ postgresql_config_path }}/conf.d"
    state: directory
    owner: postgres
    group: postgres
    mode: 0740
  become: yes

# The .pgpass file enables us to access the database with psql or
# pgdump without entering a password. It is not required but makes
# sysadmin and dev tasks more convenient.
- name: add .pgpass file for {{ unicorn_user }}
  template:
    src: pgpass.j2
    dest: "{{ unicorn_home_path }}/.pgpass"
    owner: "{{ unicorn_user }}"
    mode: 0600
  become: yes
  become_user: "{{ unicorn_user }}"

- import_tasks: wal2json.yml
  tags: wal2json

- name: flush handlers before proceeding
  meta: flush_handlers

- import_tasks: fix_template_encoding.yml
  delegate_to: "{{ postgres_delegate_host }}"
  tags: template_encoding

