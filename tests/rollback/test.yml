---
- name: test
  hosts: ofn_servers
  remote_user: "{{ user }}"

  tasks:
    - name: test | rollback | check data has been reverted
      become: yes
      become_user: postgres
      command: |
        psql {{ db }} -tAc "
        SELECT 1 FROM spree_preferences
        WHERE value='rollback_test' AND key='spree/app_configuration/privacy_policy_url';"
      changed_when: False
      register: rollback_test
      failed_when: rollback_test.stdout == '1'

    - name: test | rollback | check files in app folder have been reverted
      stat:
        path: "{{ current_path }}/.rollback_test"
      register: rollback_file_test
      failed_when: rollback_file_test.stat.exists
